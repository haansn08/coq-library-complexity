\newcommand{\strentD}[1]{\ensuremath{\rightsquigarrow^D}}

\chapter{Reducing PR to Binary PR}\label{chap:pr_bpr}
In this chapter, we reduce \PR{} instances over an arbitrary finite alphabet $\Sigma : \finType$ to a binary alphabet over type $\bool$. The idea of this reduction is to replace every symbol $\sigma : \Sigma$ with a bitstring of length $\length{\Sigma}$. This operation is incorporated using special string homomorphisms which we call uniform.
For the reduction, we need to modify the offset $o$ of the \PR{} instance by multiplying it with $\length{\Sigma}$. This is motivated by the fact that, semantically, a bitstring of length $\length{\Sigma}$ represents a single symbol of the original alphabet.

We call the variant of \PR{} where the alphabet is fixed to $\bool$ \BPR{}. All definitions of Section~\ref{sec:pr} carry over.

\section{Uniform Homomorphisms}
We introduce string homomorphisms and a special subclass of them, uniform homomorphisms. 

\newcommand{\homomorphism}{\textsf{homomorphism}}
\begin{definition}[String Homomorphisms]
  Given types $\Sigma_1, \Sigma_2$, $h : \listsof{\Sigma_1} \rightarrow \listsof{\Sigma_2}$ is a homomorphism, written \mnotec{$\homomorphism~h$}, if $h (a_1 \concat a_2) = h(a_1) \concat h (a_2)$ for all $a_1, a_2 : \listsof{\Sigma_1}$. 
\end{definition}

\begin{fact}
  Fix a homomorphism $h : \listsof{\Sigma_1} \rightarrow \listsof{\Sigma_2}$. 
  \begin{enumerate}
    \item $h~\nil = \nil$
    \item $h (a :: b) = h [a] \concat h b$
    \item $h (\rconcat~l) = \rconcat~(\withl h~x \withm x \in l \withr)$
  \end{enumerate}
\end{fact}

Given a function $f : \Sigma_1 \rightarrow \listsof{\Sigma_2}$, we can define a canonical homomorphism lifting $f$ to lists.
\newcommand{\canonicalHom}{\textsf{canonicalHom}}
\begin{definition}[Canonical Homomorphism]
  \[\canonicalHom~f \defeq \lambda~l. \rconcat~(\withl f~x \withm x \in l \withr)\]
\end{definition}

\begin{proposition}
  Let $f : \Sigma_1 \rightarrow \listsof{\Sigma_2}$. 
  \begin{enumerate}
    \item $\homomorphism~(\canonicalHom~f)$
    \item $\forall h, \homomorphism~h \rightarrow (\forall x, h [x] = f x) \rightarrow h \equiv \canonicalHom~f$
  \end{enumerate}
\end{proposition}

A uniform homomorphism is a special kind of homomorphism. First of all, it is $\varepsilon$-free, meaning that it only maps $\nil$ to $\nil$. Secondly, it maps all pairs of strings $a, b$ with $\length{a} = \length{b}$ to strings of the same length. 
Put differently, the length of every string is multiplied by a constant $k$ when passing through the homomorphism. 

\newcommand{\uniformHomo}{\textsf{uniformHomo}}
\begin{definition}[Uniform Homomorphisms]
  \[\uniformHomo~h \defeq \homomorphism~h \land (\forall x, \length{h~[x]} \ge 1) \land (\forall x_1~x_2, \length{h~[x_1]} = \length{h~[x_2]})\]
\end{definition}
Note that the definition is in terms of singleton lists. The more general property follows directly by using the properties of a homomorphism:
\begin{proposition}
  Let $h : \listsof{\Sigma_1} \rightarrow \listsof{\Sigma_2}$ with $\uniformHomo~h$.
  \begin{enumerate}
    \item $\length{l_1} = \length{l_2} \rightarrow \length{h~l_1} = \length{h~l_2}$
    \item $h~l = \nil \rightarrow l = \nil$
  \end{enumerate}
\end{proposition}

Again, we can define a canonical uniform homomorphism starting from a function $f : \Sigma_1 \rightarrow \listsof{\Sigma_2}$ satisfying $\length{f~x} = k > 0$ for all $x : \Sigma_1$. 
\begin{proposition}[Canonical Uniform Homomorphisms]
  Let $f : \Sigma_1 \rightarrow \listsof{\Sigma_2}$ with $\forall x, \length{f~x} = k$ for some $k > 0$. 
  Then $\uniformHomo~(\canonicalHom~f)$. 
\end{proposition}

\section{Applying Uniform Homomorphisms to PR}
We can now show that \PR{} is invariant under injective uniform homomorphisms. That is, given a uniform homomorphism $h$ and a \PR{} instance $S$, we can define another \PR{} instance $S'$ where we have applied $h$ to all strings of $S$. $S'$ is a yes-instance if, and only if, $S$ is a yes-instance. 

We assume that $\length{\Sigma_1} > 0$. Instances of \PR{} not satisfying this property are trivial no-instances. 

Fix a \PR{} instance $S = (\Sigma_1, o, \omega, x_0, R, \Rfinal, t)$. 
For simplicity, we assume that the homomorphism is given as $h' : \Sigma_1 \rightarrow \Sigma_2$ with 
\begin{gather*}
  (A_1) \quad \length{h'~x} = k~\text{for } k > 0 \\
  (A_2) \quad \textsf{injective}~h'
\end{gather*}
\todo{maybe show that this is wlog}

We then define $h \defeq \canonicalHom~h'$. 
Properties $(A_1)$ and $(A_2)$ carry over to $h$:
\begin{proposition}
  \begin{enumerate}
    \item $\uniformHomo~h$
    \item $\length{h~x} = k \cdot \length{x}$
    \item $\textsf{injective}~h$
  \end{enumerate}
\end{proposition}

Homomorphisms can, of course, be lifted to rewrite windows. 
\begin{definition}
  \[h_\text{window}~w\defeq (h~(\prem w), h~(\conc~w)) \]
\end{definition}
We can now define the transformed \PR{} instance as
\begin{align*}
  R_h &\defeq \withl h_\text{window}~w \withm w \in R \withr \\
  S' &\defeq (\Sigma_2, k \cdot o, k \cdot \omega, h~x_0, \textsf{hwindows}, \withl h~l \withm l \in \Rfinal \withr, t).
\end{align*}
The goal for the rest of this section is to show that $\PR{}~S \leftrightarrow \PR{}~s'$. 

We start with the agreement of $\rewHead{}{}{}$.
The first statement of the following Lemma~\ref{lem:rewHead_agree} is the equivalence one would expect. However, it is rather weak, as the backwards direction requires that we know the premise and conclusion to be in the image of $h$.
For the proof of equivalence of $S$ and $S'$, we need a stronger statement: if we have a string $h~a$ that rewrites to a string $s$, we need to be able to derive that $s$ is in the image of $h$.

\begin{lemma}[Agreement of $\rewHead{}{}{}$]\label{lem:rewHead_agree}
  \begin{enumerate}
    \item $\rewHead{w}{a}{b} \leftrightarrow \rewHead{(h_{\text{window}}~w)}{(h~a)}{(h~b)}$
    \item If $w \in \textsf{hwindows}$, $\length{a_1} = o$, $\length{u} = k \cdot o$, and $\rewHead{w}{(h~a_1 \concat h~a_2)}{(u \concat v)}$, then there exists $b_1$ with $u = h~b_1$ and $\length{b_1} = o$.
  \end{enumerate}
\end{lemma}
\begin{proof}
  \begin{enumerate}
    \item 
    \item
  \end{enumerate}
\end{proof}

This can be lifted to $\strent{}$. For the proof, yet another characterisation of validity will be quite convenient:
\begin{align*}
  \infer{a \strentD{R} b}{\length{a} = \length{b} \quad \length{a} = \omega \quad w \in R}
  \quad 
  \infer{(u \concat a) \strentD{R} (v \concat b)}{a \strentD{R} b \quad \length{u} = o \quad \length{v} = o \quad w \in R \quad \rewHead{w}{(u \concat a)}{(v \concat b)}}
\end{align*}
To some extent, this is the most intuitive characterisation of validity: it does not allow vacuous rewrites (i.e.\ allows only rewrites of length $\ge \omega$). Accordingly, it is not fully equivalent to $\strent{}$:
\begin{lemma}[Agreement of $\strent{}$ and $\strentD{}$]
  \[a \strent{R} b \land a \ge \omega \leftrightarrow a \strentD{R} b \]
\end{lemma}
\begin{proof}
  \todo{prove it!}
\end{proof}

The restriction to strings of length at least $\omega$ does not pose a problem as Definition~\ref{def:pr} imposes that as a syntactic constraint.
Using the new characterisation, we can now prove the equivalence.
\begin{lemma}[Agreement of $\strent{}$]
  Let $a$ be given with $\length{a} \ge \omega$.
  \begin{enumerate}
    \item $a \strent{R} b \rightarrow (h~a) \strent{R} (h~b)$
    \item $(h~a) \strent{} b' \rightarrow \exists b, b' = h~b \land a \strent{R} b$. 
  \end{enumerate}
\end{lemma}


\section{The Reduction}

\section{Mechanisation}
